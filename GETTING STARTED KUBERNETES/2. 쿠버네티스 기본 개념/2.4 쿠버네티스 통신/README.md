# 쿠버네티스 통신
## 쿠버네티스에서 통신할때 나타나는 몇가지 특징
### 1. 파드가 사용하는 네트워크와 호스트(노드)가 사용하는 네트워크는 다르다.
노드 내에 파드들은 가상의 네트워크(파드 및 컨테이너가 사용한느 네트워크)를 사용하고, 호스트는 물리 네트워크(마스터 및 워커 노드가 사용하는 네트워크)를 사용한다.

### 2. 같은 노드에 떠 있는 파드끼리만 통신할 수 있다.
같은 노드에 떠 있는 파드끼리는 통신이 가능하지만, 다른 노드와 파드 또는 외부와의 통신은 불가능하다.

### 3. 다른 노드의 파드와 통신하려면 CNI 플러그인이 필요하다
CNI(Container Network Interface)는 쿠버네티스 클러스터 내에서 파드와 파드, 파드와 외부와의 통신을 가능하게 해주는 플러그인이다.  
자동으로 구성되지 않으므로 별도로 설치해야 한다.

# 2.4.1 같은 파드에 포함된 컨테이너 간 통신
하나의 파드에는 하나의 가상 네트워크가 생성되며 그 파드내에 존재하는 컨테이너들은 같은 가상 네트워크를 사용하기 때문이다.  
하나의 파드내에 존재하는 컨테이너들은 모두 동일한 IP를 사용한다.  
같은 파드내에 존재하는 컨테이너들이 모두 동일한 IP를 사용하기 때문에 구별하는 방법은 포트이다.  
예를 들어 사용자가 컨테이너2의 서비스에 접근한다면 http://a.com:1002처럼 URL에 포트 정보를 입력하면 이후 eth0와 veth0을 거쳐 서비스(컨테이너2)에 접근하게 된다.  
veth0과 eth0 사이에는 docker0라는 브리지가 존재한다.

# 2.4.2 단일 노드에서 파드 간 통신
단일 노드에 떠 있는 파드들은 같은 대역(veth0: 172.10.0.1, veth1: 172.10.0.2 등)을 사용하므로 앞에서 언급한 docker0라는 브리지를 통해 서로 통신한다.

# 2.4.3 다수의 노드에서 파드 간 통신
오버레이 네트워크는 노드에서 사용하는 물리적인 네트워크 위에 가상의 네트워크를 구성한다.  
오버레이 네트워크를 사용하면 쿠버네티스 클러스로 묶인 모든 노드에 떠 있는 파드 간의 통신이 가능해진다.    
쿠버네티스는 오버레이 네트워크를 구성하기 위해 클러스터를 구성할 때 CNI 규약을 따르는 플러그인을 설치해야 한다.  
쿠버네티스는 기본적으로 쿠버넷(kubenet)이라는 기본적이고 간단한 네트워크 플러그인을 제공하지만 다수의 노드에 떠 있는 파드 간의 통신이나 네트워크 정책 설정 같은 고급 기능은 제공하지 않는다.  
대표적으로 플라넷(flannel)이나 칼리코(Calico)가 있다.  
플라넷을 설치하면 다음과 같은 순서로 통신하게 된다.  

![스크린샷 2024-01-11 오후 5 05 52](https://github.com/jisu3316/til/assets/95600042/7072e370-8e9b-4215-9ec4-6cd84e3d0779)

### 통신 순서
파드 -> veth1 -> 플라넬 CNI -> eth0 -> 라우터/게이트웨이 -> eth1 -> 플라넬 CNI -> veth0 -> 파드

플라넬 같은 오버레이 네트워크에서는 가상 네트워크 인터페이스 및 라우터의 라우팅 규칙 같은 기능을 제공한다.

## 쿠버네티스에서 사용할 수 있는 CNI 플러그인

### 1. 플라넷(flannel)
쿠버네티스와 함께 사용할 수 있는 오버레이 네트워크 플러그인이다.

### 2. 칼리코(Calico)
캡슐화 또는 오버레이 없이 파트 간에 통신이 가능한 네트워크를 제공하는 플러그인이다.

### 3. 실리움(Cilium)
리눅스 커널 기술을 이용해 데이터 경로의 필터링, 트래픽 모니터링 및 리디렉션을 수행한다.

### 4. 멀터스(Multus)
쿠버네티스에서 다중 네트워크 지원을 위한 멀티 플로그인으로 다수의 CNI 플러그인을 사용할 수 있게 해준다.  
멀터스는 CNI 사양을 구현하는 다양한 유형의 플러그인(플라넬, DHCP, Macvian, 칼리코, 위브, 실리움, 콘티브)을 지원한다.  
또한 NFV 기반 응용 프로그램과 함께 SRIOV, DPDK, OVS-DPDK, VPP도 지원한다.

# 2.4.4 파드와 서비스 간 통신
파드와 서비스 간의 통신을 알아보기에 앞서 서비스의 특성을 이해해야 한다.

- 서비스도 파드처럼 IP를 갖는다.
- 파드와 서비스에서 사용하는 IP 대역은 다르다. 예를 들어 파드의 IP 대역은 10.244.1.x 지만 서비스에서 사용하는 IP 대역은 10.101.x.x 이다.
- 서비스에서 사용하는 가상 네트워크는 ifconfig나 라우팅 테이블에서 사용할 수 없다

서비스 IP는 라우팅 테이블에서 확인할 수 없지만 외부에서 서비스IP로 요청하면 서비스 IP는 특정 파드에 전달된다. 어떻게 되는 것일까?  

## 서비스간 통신 시나리오
1. Client 파드는 서비스 이름(service-request)으로 http 요청을 한다.
2. 이후 클러스터 DNStjqj(Coredns)는 서비스 이름에 해당하는 서비스 IP(10.5.1.10)를 응답한다.
3. 서비스 IP를 전달받은 클라이언트 파드는 해당 IP에 요청을 한다.
4. 이때 워커 노드1이라는 호스트에서는 자신의 라우팅 테이블에 10.5.1.10 이라는 IP가 있는지 검색한다.
5. 검색 결과가 없으면 라우터/게이트웨이로 IP를 전달한다.
6. 그러나 다른 워커 노드에서도 10.5.1.10이라는 IP를 찾을 수 없다.(브리지나 라우팅 테이블에서 서비스IP는 검색 되지 않는다.)

그러면 어떻게 10.5.1.10이라는 서비스 IP로 요청을 보낸 클라이언트 파드가 서비스에 접근할 수 있을까?  
이것이 가능한 이유는 리눅스 커널에서 제공하는 netfilter와 iptables를 이용해 서비스 IP를 파드 IP로 변환하기 때문이다.    
그런 의미로 netfilter를 프록시라고도 한다.


# 2.4.5 외부와 서비스 간 통신
기본적으로 서비스는 클러스 내부적으로만 통신할 수 있게끔 설계되었다.  
하지만 파드는 외부와의 통신도 필요하다. 외부와 통신할 수 있게 다음과 같은 서비스 유형을 제공하고 있다.

## 노드포트(NodePort)
노드 포트는 말 그대로 노드IP(eth)에 포트를 붙여서 외부에 노출시키는 것을 말한다. 
예를 들어 노드의 IP가 192.168.10.2라면 포트를 붙여서 192.168.10.2:30000으로 외부에 노출시키는 것이다.

## 로드밸런서(LoadBalancer)
로드밸런서는 AWS, 애저, GCP과 같은 퍼블릭 클라우드에서 지원하는 쿠버네티스 로드밸런서 장비를 사용한다.
클라우드에서 제공하는 로드밸런서와 파드를 연결한 후 해당 로드밸런서 IP를 이용해 클러스터 외부에서 파드에 접근할 수 있도록 해준다.

## 인그레스(Ingress)
인그레스는 클러스터 외부에서 내부로 접근하는 요청들을 어떻게 처리할지에 관한 규칙 모음이다.
인그레스 자체는 클러스터 외부에서 URL로 접근할 수 있도록 로드밸런싱, SSL, 인증서 처리 등의 규칙을 정의한 것에 불과하며 실제로 동작시키는 것은 인그레스 컨트롤러 이다.


































