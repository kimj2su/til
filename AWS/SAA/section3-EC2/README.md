# EC2

## EC2 개요
- AWS 클라우드 컴퓨팅 서비스 = 클라우드 가상 서버(Virtual Machine)
- EC2 클라우드 가상 서버를 인스턴스라고 부른다.
- EC2 인스턴스 생성 방법
  1. 이름 및 태그
  2. 애플리케이션 및 OS 이미지
  3. 인스턴스 유형
  4. 키 페어
  5. 네트워크 설정
  6. 스토리지 구성
  7. 고급 세부 정보

## EC2 인스턴스 원격 접속 실습

### SSH 연결 (Linux 인스턴스)
- SSH(Secure Shell) : 원격 접속 프로토콜을 이용해 Linux 인스턴스에 원격으로 연결 및 파일 전송 가능
- SSH(Secure Shell Protocol)은 보안을 통해 원격으로 접속하기 위한 방식
- 아이디, 패스워드 방식이 아닌 Public Key와 Private Key를 이용해 접속
- 원격 접속 방법 : MAC PC의 Terminal, Windows Powershell, Windows Putty 프로그램 등을 사용

### RDP 연결 (Windows 인스턴스)
- RDP 프로토콜을 이용해 Windows 인스턴스에 원격으로 연결 및 파일 전송 가능
- RDP(Remote Desktop Protocol)는 Windows OS를 원격으로 접속하기 위한 방식
- 아이디, 패스워드를 이용해 접속
- 원격 접속 방법 : 윈도우의 원격 데스크톱 연결 프로그램 사용

### Instance Connect 연결(Linux 인스턴스)
- AWS 콘솔 웹 브라우저를 이용해 EC2 인스턴스에 연결
- SSH 프로토콜을 사용하여 일회용 SSH 퍼블릭키를 인스턴스 메타데이터에 업로드해서 EC2 연결
- SSH 프로토콜을 사용하기에 22번 포트가 오픈 되어 있어야 연결 가능
- PowerShell이나 Putty를 이용한 SSH 연결처럼 프라이빗 키를 다운로드 받을 필요가 없음
- Linux 인스턴스만 연결 가능

## EC2 Linux 인스턴스 웹서버 생성 실습
- SSH 원격 접속 후 리눅스 명령어 입력을 통한 웹 서버 생성
- 아래 명령어를 입력하기 전에 sudo su를 입력하여 root 계정으로 전환 후 아래 명령어 입력
- 웹 서버 생성 명령어
  - yum update -y
  - yum install httpd -y
  - service httpd start
  - chkconfig httpd on
  - cd /var/www/html
  - echo "Hello AWS EC2.%(hostname -f)" > index.html

## EC2 인스턴스 구매 옵션
- 온디맨드 인스턴스
  - 약정 없이 초당 사용한 만큼 비용 지불
- 예약 인스턴스
  - 1년 도는 3년 기간을 약정하여 인스턴스를 사용
- Saving Plan
  - 1년 또는 3년 기간의 일정 사용량을 약정하여 시간당 요금으로 인스턴스를 사용
- 스팟 인스턴스
  - 현재 사용하지 않는 예비 용량의 인스턴스를 구매하여 사용
- 전용 호스트/전용 인스턴스
  - 전용 물리적 서버를 할당 받아서 인스턴스를 사용
- 온디맨드 용량 예약
  - 원하는 기간 동안 특정 가용 영역의 용량을 예약하여 인스턴스 사용

### 온디맨드 인스턴드(On-Demand Instance)
- 사용한 만큼만 비용을 지불하는 인스턴스
- 처음 60초 이후 초당 과금
- 장기 약정이나 선 결제가 없음
- 단기간 동안 예측할 수 없는 워크로드 및 중단되어서는 안되는 애플리케이션에 적합
- EC2에 처음으로 개발 중이거나 시험 중인 애플리케이션 사용에 적합
- 온디맨드 인스턴스를 통해 비용을 대폭 절감하려면 AWS Savings Plans, Spot Instances 또는 Reserved Instances를 사용

### 예약 인스턴스(Reserved Instance)
- 1년 또는 3년약정으로 구매하는 인스턴스
- 온디맨드에 비해 최대 72% 저렴(할인율은 AWS 정책에 따라 변경 가능)
- 수요가 꾸준하고 예측 가능한 경우에 유용
- 결제옵션은 전체 선결제, 부분 선결제, 선결제 없음 3가지 선택가능
- 예약 인스턴스 유형
  - 표준 예약 인스턴스(Standard Reserved Instances) : 인스턴스 타입을 지정하면 예약기간 동안 변경 불가능
  - 전환형 예약 인스턴스(Convertible Reserved Instances) : 예약기간동안 인스턴스 타입 변경 가능
- 예약 인스턴스는 AWS Marketplace에서 판매가능
  - 약정이 만료되기 전에 프로젝트가 종료될 경우, 불필요한 용량이 있는 경우 예약 인스턴스를 판매

### Saving Plan
- 1년 또는 3년 기간에 일정 사용량 약정(컴퓨팅 사용량에 대한 약정)으로 구매하는 인스턴스
- 사용량은 시간당 USD 요금으로 측정
- 예, 한 시간에 $5의 컴퓨팅 사용량을 약정하면 $5까지 Saving plans 가격이 청구 되고 초과 사용량은 온 디맨드 요금이 청구 됨
- 온디맨드에 비해 최대 66~72% 저렴 (할인율은 AWS 정책에 따라 변경 가능)
- Compute Saving Plans와 EC2 Instance Saving Plans 두 가지 유형이 있음
- Saving Plans 유형
  - Compute Saving Plans
    - 인스턴스 패밀리(예:m5,c5 등), 인스턴스 크기(c5.large, c5.xlarge), 리전(us-east-1,us-east-2), 운영체제(Windows,Linux) 또는 테넌시에 관계없이 EC2인스턴스 사용에 자동으로 적용
    - EC2 뿐만 아니라 Lambda 및 Fargate 서비스에도 적용 됨
  - EC2 Instance Saving Plans
    - 특정 리전의 특정 인스턴스 패밀리 사용량 약정(버지니아 북부 리전의 MM5 사용량)
    - AZ, 규모, OS 또는 테넌시 종류는 리전과 인스턴스 패밀리 내에서 자유롭게 선택 가능

### 스팟 인스턴스(Spot Instance)
- 사용하지 않는 예비 EC2 용량을 구매하여 사용하는 방식
- 온디맨드 인스턴스보다 최대 90% 저렴(할인율은 AWS 정책에 따라 변경 가능)
- 가장 저렴한 인스턴스 구매옵션
- 수요에 따라 언제든 인스턴스가 종료(종료 2분전 알림)될 수 있기 때문에 서버가 중단없이 지속적으로 실행 되어야하는 경우 사용 안하고 언제든지 시작 및 종료가 가능한 경우에 사용
- 사용 사례
  - 유연한 상태 비저장, 내결함성 애플리케이션에 권장
  - 예를 들어 스팟 인스턴스는 빅 데이터, 컨테이너화된 워크로드, CI/CD, 상태 비저장 웹 서버, 고성능 컴퓨팅(HPC), 렌더링 워크로드에 적함
- Spot Fleet: 여러개의 스팟 인스턴스를 하나의 그룹으로 묶은 것(스팟 인스턴스들의 집합)
- EC2 Fleet: 예약  인스턴스 또는 온디맨드 인스턴스 + 스팟 플릿 인스턴스(짧은 시간 급격하게 증가도니 용량이 필요한 경우)의 조합을 통해 비용 효율적인 인스턴스 그룹을 구성 가능

### 전용 호스트 / 전용 인스턴스
- 전용 호스트(Dedicated Hosts)
  - 물리적인 전용 서버를 할당 받아 사용하는 방식 (다른 AWS 계정과 동일한 하드웨어를 공유하지 않음)
  - 호스트 단위 결제
  - CPU 소켓, 코어 등이 표시 됨
  - 사용자가 인스턴스 배치 방법을 지정할 수 있음
  - 소켓당, 코어당 또는 VM 당으로 사용하는 소프트웨어 라이선스 사용 가능
  - CPU 코어나 물리적 서버에 할당되는 라이선스를 기존에 보유한 경우에 적합
- 전용 인스턴스(Dedicated Instances)
  - 물리적인 전용 서버를 할당 받아 사용하는 방식 (다른 AWS 계정과 동일한 하드웨어를 공유하지 않음)
  - 동일한 계정의 다른 인스턴스가 하드웨어를 공유할 수 있음
  - 인스턴스 단위 결제
  - 전용 호스트에서 사용 가능한 CPU 코어 표시, 인스턴스 배치, 사용자 라이선스 사용 불가

### 온디맨드 용량 예약(On-Demand Capacity Reservations)
- 특정 가용 영역의 Amazon EC2 인스턴스에 대해 원하는 기간만큼 컴퓨팅 용량을 예약하여 사용
- 예약한 기간에 인스턴스를 사용하지 않아도 인스턴스 사용비용이 아닌 예약 비용은 청구됨
- 용량 예약시 인스턴스가 필요할 때 온디맨드 용량을 확보하지 못할 위험을 줄일 수 있음
- 용량 요구 사항이 엄격하고 특정 수준의 장기 또는 단기 용량 봊으이 요구되는 비즈니스 크리티컬 워크로드를 실행하는 경우 사용
- 사용사례
  - 재해 복구 : 다른 가용 영역 또는 리전의 용량을 예약하여 장애 조치 이벤트 발생 시에 필요한 용량을 사용할 수 있도록 보장
  - 규정 요건 : 용량예약을 사용하여 고가용성에 대한 규정 요건을 충족하기위해 해당 리소스를 활용하지 않더라도 용량을 확보
  - 이벤트 : 비즈니스 크리티컬 이벤트가 발생하기 전에 용량 예약을 생성하여 필요할 때 확장

## EC2 인스턴스 유형
- 인스턴스를 생성할 때 지정하는 인스턴스 유형에 따라 컴퓨터의 하드웨어 사양이 결정됨
- 인스턴스 유형은 CPU, 메모리, 스토리지 및 네트워킹 용량의 여러 조합으로 구성됨
- 애플리케이션의 사용 목적에 따라 적합한 유형을 선택하여 인스턴스를 시작
- 인스턴스 유형은 목적에 따라 범용, 컴퓨팅 최적화, 메모리 최적화, 가속화된 컴퓨팅, 스토리지 회적화 HPC 최적화 인스턴스 패밀리로 분류됨
- https://aws.amazon.com/ko/ec2/instance-types/

## EC2 네트워킹
- 인스턴스를 시작할 때 VPC에서 서브넷 선택가능
- 인스턴스 시작시 네트워크 통신을 위해 기본 네트워크 인터페이스가 생성 됨
- 인스턴스는 서브넷의 IP 주소 대역에서 프라이빗 IP 주소를 기본 네트워크 인터페이스에 할당
- 퍼블릭 IP 주소가 필요한 경우 네트워크 인터페이스에 할당

## Elastic Network Interface(ENI)
- 가상 네트워크 인터페이스
- IP 주소, MAC 주소 등이 부여 됨
- 인스턴에 연결되어 네트워크 통신을 하는 역할
- 인스턴스 생성시 기본(Primary) 네트워크 인터페이스가 IP 주소 등의 정보 할당과 함께 생성됨
- EC2에 추가로 여러 개의 네트워크 인터페이스 연결 가능
- 인스턴스 유형에 따라 사용가능한 최대 네트워크 인터페이스 개수와 IP 주소 개수가 다름
- 하나 이상의 보안 그룹을 연결 할 수 있음

## 보안 그룹 (Security Group)
- EC2 인스턴스에 대한 인바운드 및 아웃바운드 트래픽을 제어하는 가상 방화벽 역할
- EC2 인스턴스 ENI와 연결 됨
- 보안 그룹은 허용 규칙만 지정 가능하고 거부 규칙은 지정할 수  없음
- 보안 그룹은 연결 상태를 추적하는 상태저장 방화벽(Stateful Firewall)
- 인바운드 트래픽 : 외부에서 EC2 인스턴스로 들어오는 트래픽
- 아웃바운드 트래픽 : EC2 인스턴스에서 외부로 나가는 트래픽
- 제어 규칙
  - 트래픽 유형 (예, SSH, HTTP 등)
  - 프로토콜 (TCP, UDP 등)
  - 포트(예, SSH 22, HTTP 80, HTTPS 443, MySQL 3306 등)
  - 대상 (개별 IP 주소, IP 주소 대역, 다른 보안 그룹)

### 보안 그룹 - Stateful (상태 저장)
- 아웃바운드 규칙에 상관없이, 허용된 인바운드 트래픽에 대한 반응으로 외부로 나가는 흐름이 수행
  - 아웃바운드 규칙에 상관없이, 허용된 인바운드 트래픽에 대한 반응으로 외부로 나가는 흐름이 수행
  - 사용자가 인스턴에서 요청을 전송하면 해당 요청의 응답 트래픽은 인바운드 보안 그룹 규칙에 상관없이 인바운드 흐름이 허용

## 탄력적 IP
### Publifc IP vs Private IP
- 퍼블릭 IP : 인터넷 연결에 사용하는 IP
- 프라이빗 IP : 회사나 집의 내부에서만 사용하는 IP, 직접적으로 인터넷 연결이 안되며 인터넷 게이트웨이를 통해야 함

### 탄력적 IP (Elastic IP)
- 인스턴스 생성시 자동으로 할당 받은 Public IP는 인스턴스를 재시작 하면 다른 IP로 재할당 받기에 Public IP 주소가 변경됨
- Elastic IP는 인터넷에 연결 가능한 고정적(정적)인 퍼블릭 IP 주소
- EC2인스턴스의 ENI에 탄력적 IP주소를 연결하면 EC2 인스턴스를 다시 시작해도 동일한 Public IP 주소로 접속할 수 있음
- Elastic IP는 생성한 리전 내에서만 사용가능하며 다른 리전으로 이전할 수 없음
- 실행 중인 인스턴스와 연결되지 않은 탄력적 IP 주소에 대해서는 소액의 시간당 요금이 부과 됨

## AMI(Amazon Machine Image)
- 인스턴스를 시작하는데 필요한 소프트웨어 구성(운영체제, 애플리케이션 서버 및 애플리케이션)이 포함 된 템플릿
- EC2 인스턴스를 시작하는데 AMI 지정해야하며 EC2 인스턴스 시작 시 OS 설치나 서버 소프트웨어 설정 등을 별도로 할 필요 없음
- 운영 중인 EC2 인스턴스를 커스텀 AMI로 만들어서 동일한 환경으로 구성된 EC2를 빠르게 시작 가능
- AMI 유형
  - Quickstart AMI : AWS에서 제공하는 자주사용하는 소프트웨어로 구성된 AMI
  - 내 AMI : 사용자가 직접 만든 AMI
  - AWS Marketplace AMI : 서드파티 회사에서 등록한 AMI(온라인 소프트웨어 상점)
  - 커뮤니티 AMI : AWs 개발자 커뮤니티 회원들이 올린 AMI