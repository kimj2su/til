# 고가용성 기능의 필요성
만약 복제 기능을 사용하고 있는데 마스터 노드가 죽는다면
1. 복제본 노드에 접속한뒤 replica of no one 커맨드를 입력해 읽기 전용 상태 해제
2. 애플리케이션 코드에서 레디스의 엔드포인트를 복제본의 IP로 변경
3. 배포

만약 운영 환경에서 별다른 고가용성 기능의 도입 없이 위와 같은 복제 구성으로만 레디스를 사용한다면
마스터 노드에 발생한 장애 처리가 지연돼 바로 서비스의 기능의 문제로 이어질 수 있다.  

# 센티널(sentinel)이란?
레디스의 자체 고가용성 기능이다.  
센티널은 데이터를 저장하는 기존 렏디스 인스턴스와는 다른 역할을 하는 별도의 프로그램이며, 자동 페일오버 기능을 사용하면  
마스터 인스턴스에 장애가 발생하더라도 레디스를 계속 사용할 수 있도록 동작해 레디스의 다운타임을 최소화할 수 있다.

# 센티널 기능

## 모니터링
마스터, 복제본 인스턴스의 상태를 실시간으로 확인한다.

## 자동 페일오버
마스터의 비정상 상태를 감지해 정상 상태의 복제본 중 하나를 마스터로 승격시킨다.

## 인스턴스 구성 정보 안내
센티널은 클라이언트에게 현재 구성에서의 마스터 정보를 알려준다.
페일오버가 발생하면 변경된 마스터 정보를 재전달하기 때문에 페일오버가 발생하더라도 레디스의 엔드포인트 정보를 변경할 필요가 없다.

# 분산 시스템으로 동작하는 센티널
SPOF(Single Pont Of Failure)는 하나의 서비스에 문제가 발생했을때 전체 시스템이 영향을 받는 지점을 뜻한다.  
복제와 자동 페일오버를 이용해 고가용성을 확보하는 이유는 레디스가 SPOF가 되는 것을 방지하기 위함이다.  

센티널은 그 자체로 SPOF가 되는 것을 방지하기 위해 최소 3대 이상일 때 정상적으로 동작하 수 있도록 설계되었다.  
하나의 센티널에 이상이 생기더라도 다른 센티널이 계속해서 역할을 할 수 있게 된다.

센티널은 오탐을 줄이기 위해 쿼럼(quorum)이라는 개념을 사용한다.
쿼럼은 마스터가 비정상 동작을 한다는 것에 동의해야 하는 센티널의 수로 쿼럼을 만족하는 경우 페일오버를 시작한다.  
일반적으로 센티널 인스턴스가 3개일 때 쿼럼은 2로 설정하며 이 경우 최소 2개 이상의 센티널 인스턴스가 마스터 비정상 상태에 동의한다면 페일 오버 프로세스를 시작한다.  

센티널은 쿼럼을 이용한 과반수 선ㅊ눌 개념을 사용하기 때문에 3대 이상의 홀수로 구성하는 것이 좋다. 보통 3대로 구성하며 좀 더 견고하게 장애에 대응하고자 한다면 5대 이상으로 구성하는 것이 좋다.

# 센티널 인스턴스 배치 방법
기본적으로 센티널은 물리적으로 서로 영향받지 않는 서버에서 실행되는 것이 좋다.  
마스터의 장애를 감지할 수 있어야 하기 때문에 서로 다른 가용 영역에 배치하는 것이 일반적이다.  

센티널은 최대 3대 이상 사용해야 하며 각각은 다른 물리 서버에 배치하는 것이 좋기 때문에 보통 하나의 서버에 레디스 프로세스와 센티널 프로세스를 동시에 실행 시킨다.  
1. 서버 A - 레디스 마스터, 센티널 1
2. 서버 B - 레디스 복제본, 센티널 2
3. 서버 C - 레디스 복제본, 센티널 3

서버 A 가 죽으면 서버 B와 C의 센티널 인스턴스는 새롭게 마스터가 될 복제본을 선출 한 두, 해당 복제본 인스턴스를 마스터로 승격시킨다.
기존 마스터를 보고 있던 클라이언트는 모두 서버 B에서 새롭게 선출된 마스터로 연결되며 레디스로 새롭게 들어오는 커넥션은 모두 마스터 IP 정보로 서버 B의 레디스 주소를 전달받는다.  

서버 A가 복구 되면 센ㅌ널 인스ㅓㄴ스는 기존 마스터였던 서버 A의 레디스 인스턴스를 새롭게 마스터가 된 서버 B의 복제본이 되도록 연결 시킨다.  
이러한 과정이 자동으로 구성되며 운영자의 개입이 필요하지 않다.

만약 서버의 리소스의 여유가 있다면 위와 같이 구성하면 좋지만 복제본이 2개까지 필요하지 않을 수도 있다.  
그럴 경우 A, B 서버에는 동일하고 서버 C에는 센티널만 실행시키도록 배치할 수 있다.  
센티널만 실행될 서버에는 데이터 저장 및 클라이언트 요청도 받지 않기 때문에 최저 사양의 스펙으로 구성해도 괜찮다.

# 센티널 인스턴스 실행하기
- redis port : 6379
- sentinel port : 26379

## ㅅ티널 프로세스 실행
센티널 프로세스를 실행하기전 마스터와 복제본 노드간 복제 연결이 된 상태로 만들어야 한다.
```redis
replicaof 127.0.0.1 6379
```

센티널 프로세스를 띄우기 위해서는 sentinel.conf라는 별도의 구성 파일이 필요하다.  
sentinel.conf에 다음과 같은 내용을 추가한뒤 센티널 프로세스를 시작한다.
```redis
port 26379
sentinel monitor master-test 127.0.0.1 6379 2
```
- port : 센티널 프로세스가 사용할 포트
- sentinel monitor : 마스터의 이름, 마스터의 IP, 마스터의 포트, 쿼럼, 마스터의 이름에는 특수 문자나 공백은 포함할 수 없으며, 알파벳, 숫자 .,_, _ 만 사용할 수 있다.

센티널은 마스터와 복제보을 포함한 모든 레디스 프로세스를 모니터링하지만 구성 파일에는 복제본 정보를 직접 인력하지 않아도 된다.  
센티널 프로세스가 시작하면 마스터에 연결된 복제본을 자동으로 찾아내는 과정을 거친다.

이 sentinel.conf 파일을 센티널 인스턴스를 시작하려면 모든 서버에서 위의 파일을 작성한  뒤 각각 인스턴스를 시작한다.

### redis-sentinel을 이용하는 방법
```redis
redis-sentinel /path/to/sentinel.conf
```

### redis-server를 이용하는 방법
```redis
redis-server /path/to/sentinel.conf --sentinel
```

### docker를 이용하는 방법
```docker
docker run -d --name redis-sentinel -p 26379:26379 redis redis-sentinel /path/to/sentinel.conf
```

### sentinel 커맨드
```redis
# sentinel 접속
redis-cli -p 26379

# 센티널 정보 확인
sentinel master <master-name>
마스터의 ip, 포트, 연결된 복제본의 개수 등 다양한 정보 확인 가
```

- num-other-sentinels : 마스터를 모니터링하고 있는 다른 센티널의 정보를 나타 낸다.
  - 위의 예제에서는 해당 값은 2로 현재 master-test 마스터를 모니터링하고 있는 다른 센티널 노드가 추가로 2대가 존재한다는 것을 의밓ㄴ다.
- flags : 마스터의 상태를 나타낸다.
  - 마스터가 정상적이지 않다고 판단하면 s_down, o_down, failover, leader, observer 등의 상태가 표시된다.
- num-slaves : 현재 마스터에 연결된 복제본의 개수를 나타낸다.
  - 위의 예제에서는 1로 마스터에 연결된 복제본이 1개 존재한다는 것을 센티널이 인지하고 있음을 의미한다.

### sentinel replicas 커맨드를 이용하면 마스터에 연결된 복제본의 자세한 정보를 확인할 수 있다.
```redis
sentinel replicas master-test
```

### sentinel sentinels 커맨드를 이용하면 마스터를 모니터링하고 있는 다른 센티널의 정보를 확인할 수 있다.
```redis
sentinel sentinels master-test
```

### sentinel ckquorum 커맨드를 이용하면 마스터를 바로보고 있는 센티널 인스턴스가 설정한 쿼럼 값보다 큰지 확인할 수 있다.
예를 들어 정상 상태의 센티널이 3대, 쿼럼이 2일 경우 센티널 3대 모두 정상이라면 다음과 같은 값을 반환한다.
```redis
sentinel ckquorum master-test
OK 3 usable sentinels. Quorum and failover authorization can be reached
```

1대의 센티널에 문제가 생겨 정상적인 센티널이 2대가 됐을 경우  
정상적인 센티널 대수가 쿼럼 값인 2 이상이기 때문에 전체 센티널 구성은 정상적이라 판단할 수 있다.
```redis
sentinel ckquorum master-test
OK 2 usable sentinels. Quorum and failover authorization can be reached
```

만약 이상황에서 다른 1대의 센티널이 문제가 생겨 정상적인 센티널이 1대가 됐을 경우
```redis
sentinel ckquorum master-test
-NOQUORUM 1 usable sentinels. Not enough available sentinels to reach the specified quorum for this master
Not enough available sentinels to reach the specified quorum for this master
```
정상적인 센티널의 대수가 쿼럼 수보다 작기 때문에 마스터 노드에 장애가 발생해도 투표를 진행할 수 없어 페일 오버를 자동으로 실행할 수 없다.

# 페일오버 테스트
두 가지 방법을 이용해 페일오버를 발생시킬 수 있다.

## 커맨드를 이용한 페일오버발생(수동 페일 오버)
```redis
sentinel failover <master name>
```
센티널에 접속한 뒤 이 커맨드를 사용하면 다른 센티널의 동의를 구하지 않고도 페일 오버를 바로 발생시킬 수 있다.  
실제 마스터의 상태가 정상이었을 때도 이 커맨드를 사용하면 마스터와 복제본 간 롤 체인지가 발생한다.

## 마스터 동작을 중지시켜 페일 오버 발생(자동 페일오버)
직접 마스터에 장애를 발생시켜 페일오버가 잘 발생하는지 확인함으로써 마스터의 상태가 정상이 아닐 경우 센티널에서 이를 인지할 수 있는지 확인할 수 있다.  

```redis
redis-cli -h <<master-host> -p <master-port> shutdown
```
센티널은 주기적으로 마스터 노드에 ping을 보내 응답이 정상적으로 돌아오는지 확인함으로써 마스터 인스턴스의 상태를 파악한다.  
이때 sentinel.conf 파일에 설정한 down-after-milliseconds 시간 동안 마스터에서 응답이 오지 않으면 마스터의 상태가 정사적이지 않다고 판단해
페일오버를 트리거한다.  
해당 옵션의 기본값은 30000밀리초 즉 30초이므로 센티널은 30초 동안 마스터에서 응답을 받지 못했을 때 마스터의 상태가 비정상적이라 판단해 페일오버를 발생시킨다.

# 센티널 운영하기
## 패스퉈드 인증
마스터와 복제본 노드에 requirepass/masteruth 옵션을 이용해 패스워드르 설정한 경우 센티널의 설정 파일에서도 패스워드를 지정행야한다.  
센티널을 이용한 구성에서는 장애 상황에 센티널이 자동으로 페일오버를 시키기 때문에 복제 구성 내의 모든 레디스 노드는 마스터 노드가 될 가능성이 있다고 볼 수 있다.  
따라서 하나의 복제 그룹에서 설정한 값은 모든 노드에서 동일하게 설정해야 한다.  

패스워드가 걸려있는 레디스를 모니터링할 경우에는 sentinel.conf에 다음과 같인 패스워드를 지정해야한다.  
```redis
sentinel auth-pass <master-name> <password>
```

## 복제본 우선순위
모든 레디스 인스턴스는 replica-priority라는 파라미터를 가지고 있다.  
센티널은 페일오버를 진행할 때 각 복제본 노드의 우선순위를 고려해 마스터로 승격시킬 복제본을 선정한다. -> 가장 작은 노드를 마스터로 선출한다.  
기본 값은 100이며, 이 값이 0인 복제본은 절대 마스터로 선출되지 않는다.

## 운영중인 센티널 구성 정보 변경
모니터링하는 센티널이 여러대라면 각각의 센티널의 모두 설정해줘야함 -> 전파되지 않음

### sentinel monitor
센티널이 새로운 마스터를 모니터링할 수 있도록 한다.
```redis
sentinel monitor <master-name> <ip> <port> <quorum>
```

### sentinel remove
센티널이 지정한 마스터를 모니터링하지 않도록 지시한다.
```redis
sentinel remove <master-name>
```

### sentinel set
센티널의 설정을 변경한다.
```redis
sentinel set <master-name> <option> <value>
```

만약 마스터가 다운됐다는 것을 판단하는 시간인 down-after-milliseconds 값을 변경하고 싶다면 다음과 같이 한다.
```redis
sentinel set <master-name> down-after-milliseconds 30000

# 쿼럼 변경
sentinel set <master-name> quorum 2
```

레디스 6.2부터는 각 마스터에 종속되지 않는 센티널의 고유한 설정 값도 런타임 중에 변경할 수 있다.
```redis
sentinel config get <cofiguration name>
sentinel config set <cofiguration name> <value>
```

# 센티널 초기화
센틴ㄹ은 비정상적이라 판단한 복제본 노드에 대해서도 임의로 모니터링을 멈추지 않는다.
```redis
sentinel reset <master-name>
```
위의 커맨드로 센티널을 리셋하면 인스턴스의 상태 정보를 초기화하고 센티널이 모니터링하고 있는 마스터, 복제본, 다른 센티널 인스턴스의 정보를 새로 고침한다.  
마스터의 이름도 새로 정할 수 있고, 마스터 이름 대신 *를 입력해 센티널이 모니터링하고 있는 전체 마스터 정보를 초기화 할 수 있다.


# 센티널 노드의 추가/제거
마스터를 모니터링핟록 설정한 센티널 인스턴스를 실행하면 된다.   
자동 검색 매커니즘에 의해 자동으로 기존에 실행중이던 다른 센티널의 known-list에 추가된다.  
제거하기 위해서는 위와 같이 sentinel reset을 실행하면 된다.

# 센티널의 자동 페일오버 과정

## 마스터의 장애 상황 감지
센티널은 down-after-milliseconds 파라미터에 지정된 값 이상 동안 마스터에 보낸 PING에 대해 유효한 응답을 받지 못하면 마스터가 다운됐다고 판단한다.  

### sdown, odwon 실패 상태로 전환
하나의 센티널 노드에서 레디스 마스터 인스턴스에 대해 응답을 늦게 받으면 그 센티널은 마스터의 상태를 sdown으로 플래깅한다.  
sdown은 subjectly down 즉 주관적인 다운 상태를 의미한다.  

이후 센티널은 다른 센티널 노드들에게 sentinel is-master-down-by-addr <master-ip> <master-port> <current-epoch> <*> 커맨드를 보내 마스터의 장애를 알린다.
위의 커맨드를 받은 세니널들은 해당 마스터 서버의 장애를 인지했는지 여부를 응답한다.  
자기 자신을 포함해 쿼럼 값 이상의 센티널 노드에서 마스터의 장애를 인지한다면 센티널 노드는 마스터의 상태를 odown으로 변경한다.  
odwon이란 objectly down, 즉 객관적인 다운 상태가 됐음을 의미한다.  
```redis
sentinel.log
+sdow
+odown
```

## 에포크 증가
처음으로 마스터 노드를 odwon으로 인지한 센티널 노드가 페일오버 과정을 시작한다.  
센티널은 페일오버를 시작하기 전 우선 에포크값을 하나 증가시킨다.  

센티널은 에포크라는 개념을 이용해 각 마스터에서 발생한 페일오버의 버전을 관리한다.
에포크는 증가하는 숫자값으로, 처음으로 페일오버가 일어날 때의 에포크 값은 1이 된다.  
새로운 페일오버가 발생할 때마다 에포크 값은 하나씩 증가하며, 동일한 에포크 값을 이용해 페일오버가 진행되는 동안 모든 센티널 노드가
같은 작업을 시도하고 있다는 것을 보장할 수 있다.
```redis
sentinel.log
+new-epoch 1
+try-failover 1
```

## 센티널 리더 선출
에포크를 증가시킨 센티널은 다른 센티널 노드에게 센티널 리더를 선출하기 위해 투표하라는 메시지를 보낸다.  
이때 증가시키 에포크를 함께 전달하는데 해당 메시지를 받은 센티널 노드가 현재 자신의 에포크보다 전달받은 에포크가 클 경우 자신의 에포크를 증가시킨 뒤,
센티널 리더에게 투표하겠다는 응답을 보낸다.
만약 센티널 노드가 투표받았을 경우 전달받은 에포크의 값이 자신의 에포크 값과 동일 하다면 이미 리더로 선출된 센티널의 id를 반환한다.  
하나의 에포크에서 센티널은 하나의 센티널에 투표할 수 있으며, 투표 결과는 변경할 수 없다.
```redis
sentinel.log
+vote-for-leader 1 1 1
+slected-leader 1 1 1
```

## 복제 선정 후 마스터로 승격
1. redis.conf 파일에 명시된 replica-priority가 낮은 복제본
2. 마슽로부터 더 많은 데이터를 수신한 복제본(master_repl_offset)
3. 2번 조건까지 동일하다면 runID가 사전 순으로 작은 복제본

작은 runID를 선택하는것에는 특별한 이유가 없으며 임의로 하나의 노드를 선택하는 방식이다.  

선정한 복제본은 slaveof no one 커맨드를 수행해 기존 마스터로부터의 복제본을 끊는다.
```redis
sentinel.log
+failover-state-select-slave 1
+selected-slave 1
+failover-state-send-slaveof-noone 1
+failover-state-wait-promotion 1
+promoted-slave 1
```

## 복제 연결 변경
기존 마스터에 연결돼 있던 다른 복제본이 새로 승격된 마스터의 복제본이 될 수 있도록 복제본마다 replicaof new-ip new-port 커맨드를 수행한다.  
복제 그룹의 모든 센티널 노드에서도 레디스의 구성 정보를 변경한다.
```redis
sentinel.log
+failover-state-reconf-slaves 1
+slave-reconf-sent
+slabe-reconf-inprog
+slave-reconf-done
+config-update-from sentinel
```

## 장애 조치 완료
모든 과정이 완료된 뒤 센티널은 새로운 마스터를 모니터링한다.
```redis
sentinel.log
+failover-end
+switch-master
```

## 스플릿 브레인 현상
스플릿 브레인 이란 네트워크 파티션 이슈로 인해 분산 환경의 데이터 저장소가 끊어지고 끊긴 두 부분이 각각의 정상적인 서비스라고 인식하는 현상을 의미한다.  
센티널 구성에서 네트워크 단절이 발생하면 스플릿 브레인 현상이 발생할 수 있다.  

센티널 A, B, C 가 있고 마스터, 복제 노드가 있을때
A와 B,C 간의 연결이 끊기고 B,C는 복제본 노드와의 통신만 되었을 경우  
센티널 B, C는 마스터노드로의 접근이 정상적이지 않다는 것을 감지한 뒤 복제본 노드를 마스터로 승격한다.  
만약 마스터 인스턴스에는 장애가 발생하지 않았으며, 단지 노드 네트워크 간의 단절이 일어난 경우라면 하나의 복제본에 2개의 마스터가 생기는 스플릿 브레인 현상이 일어난다.  
