# 1.5 프로토콜 계층과 서비스 모델

## 1.5.1 계층 구조

### 프로토콜 계층화
네트워크 프로토콜의 설계 구조를 제공하기 위해, 네트워크 설계자는 프로토콜을 계층으로 조직한다.  
각 프로토콜은 한 계층에 속한다. 한 계층이 상위 계층에 제공하는 서비스에 관심을 갖고 이것을 계층의 서비스 모델이라고 한다.  

프로토콜 계층은 소프트웨어, 하드웨어 또는 둘의 통합으로 구현할 수 있다.

![스크린샷 2023-10-26 오후 10 44 30](https://github.com/jisu3316/til/assets/95600042/ac67829e-2f2b-46cc-8528-d735673f5632)

다양한 계층의 프로토콜을 모두 합하여 프로토콜 스택이라고 한다.  
인터넷 프로토콜 스택은 5개 계층으로 구성된다.  
이 책은 먼저 애플리케이션 계층을 다루고 다음에 아래로 내려가는 톱다운 방싱르 채택하였다.

### 애플리케이션 계층
애플리케이션 계층은 네트워크 애플리케이션과 애플리케이션 계층 프로토콜이 있는 곳이다.  
인터넷의 애플리케이션 계층은 HTTP(웹 문서 요청과 전송 제공), SMTP(전자 메일 전송 제공),
FTP(두 종단 시스템 같의 파일 전송 제공) 같은 프로토콜을 포함한다. 
www.google.com 같은 이름을 32비트 네트워크로 주소로 변환하는 네트워크 기능을 볼 것이고, 도메인 네임 서버가 돕는다.  
애플리케이션 계층 프로토콜은 여러 종단 시스템에 분산된어 있어서 한 종단 시스템에 있는 애플리케이션이 
다른 종단 시스템에 있는 애플리케이션과 정보 패킷을 교환 하는데 이 프로토콜을 사용한다.  
애플리케이션 계층에서의 이 정보 패킷을 메시지라고 부른다.


### 트랜스포트 계층
인터넷의 트랜스포트 계층은 클라이언트와 서버 간에 애플리케이션 계층 메시지를 전송하는 서비스를 제공한다.  
인터넷에는 TCP와 UDP라는 두가지 트랜스포트 프로토콜이 있으면 이들은 애플리케이션 계층 메시지를 전달한다.  
#### TCP
- 연결지향형 서비스 제공
- 긴 메시지를 짧은 메시지로 나누고 혼합 제어 기능을 제공하여 네트워크가 혼잡할 때 출발지의 전송률을 줄여줌

#### UDP
- 비 연결형 서비스 제공
- 신뢰성, 흐름 제어, 혼잡 제어를 제공하지 않는 서비스
이 책에서 트랜스포트 계층 패킷을 세그먼트라고한다.

### 네트워크 계층
인터넷의 계층은 한 호스트에서 다른 호스트로 데이터그램(datagram)을 라우팅하는 책임을 진다.
메일 서비스를 이용하기 위해 목적지 주소가 적힌 편지를 전달하는 것처럼, 
출발지 호스트에서 인터넷 트랜스포트 계층 프로토콜은 트랜스포트 계층 세그먼트와 목적지 주소를 네트워크 계층으로 전달한다.  
네트워크 계층은 세그먼트와 목적지 주소를 받아서 목적지 호스트로 전달한다.  
인터넷의 네트워크 계층은 두 가지 주요 요소를 갖는다.  
이 계층은 IP 데이터그램의 필드를 정의하며 종단 시스템과 라우터가 이 필드에 어떻게 동작하는지 정의하는 프로토콜을 갖고 있다.  
이 프로토콜이 IP 프로토콜이다.  
오직 하나의 IP 프로토콜이 있고 네트워크 계층을 가진 모든 인터넷 요소는 IP 프로토콜을 수행해야만 한다.  


### 링크 계층
경로상의 한 노드(호스트 혹은 패킷 스위치)에서 다른 노드로 패킷을 이동하기 위해 네트워크 계층 서비스에 의존해야 한다.  
- 이더넷
- 와이파이
- 케이블 인터넷
링크 계층 패킷을 프레임이라고 한다.

### 물리 계층
링크 계층의 기능이 전체 프레임을 한 네트워크 요소에서 이웃 네트워크 요소로 이동하는 것이라면 물리 계층의 기능은 프레임 내부의 각 비트를 한 노드에서 다음 노드로 이동하는 것이다.  
이 계층의 프로톨콜들은 링크에 의존하고 더 나아가 링크의 실제 전송 매체 （예: 꼬임쌍선, 단일 모드 광케이블）에 의존한다.  
예를 들어, 이더넷은 여러 가지 물리 계층 프로토콜을 갖고 있다（꼬임쌍선용, 동축케이블용, 광케이블용 등）.  
각각의 경우에 비트는 다른 방식으로 링크 반대편으로 이동된다.

## 1.5.2 캡슐화
![스크린샷 2023-10-26 오후 11 14 49](https://github.com/jisu3316/til/assets/95600042/cc822cce-0d93-4ca5-bd6f-4f58465705a1)
<br/>

라우터와 링크 계층 스위치는 둘 다 패킷 교환기다.  
위 그림 처럼 링크 계층 스위치는 1, 2 계층을 구현하고 라우터는 1, 2, 3계층을 구현한다.
인터넷 라우터들이 IP 프로토콜(3계층 프로토콜)을 구현할 수 있지만, 링크 계층 스위치는 그럴 수 없다.  
링크 계층 스위치는 IP 주소를 인식하지 못하지만 이더넷 주소 같은 2계층 주소는 인식할 수 있다.  
호스트는 다섯 계층 모두를 구현한다.  

### 캡슐화 과정

1. 송신 호스트에서 `애플리케이션 계층 메시지(application-layer message, 위 그림에서의 M)`는 트랜스포트 계층으로 보내진다.
2. 가장 간단한 경우, 트랜스포트 계층은 메시지에 수신 측 트랜스포트 계층에서 사용될 추가 정보인 `트랜스포트 계층 헤더 정보(Ht)`를 더한다.

<br/>

> `트랜스포트 계층 세그먼트(transport-layer segment)` = 애플리케이션 계층 메시지 + 트랜스포트 계층 헤더 정보

- 트랜스포트 계층 세그먼트는 애플리케이션 계층 메시지를 **캡슐화**한다.
- 트랜스포트 계층 헤더 정보가 포함하는 내용은 다음과 같다.
    - 수신 측의 트랜스포트 계층이 그 메시지를 적절한 애플리케이션으로 보내도록 하는 정보들
    - 메시지의 비트들이 변경되었는지 아닌지를 수신자가 결정하게 하는 오류 검출 비트

<br/>

3. 트랜스포트 계층은 세그먼트를 네트워크 계층으로 보낸다.
4. 네트워크 계층은 출발지와 목적지 종단 시스템 주소와 동일한 헤더 정보(Hn)를 추가하여 `네트워크 계층 데이터그램(network-layer datagram)`을 만든다.

<br/>

5. 데이터그램은 링크 계층으로 전달된다.
6. 링크 계층도 자신의 헤더 정보를 추가하여 `링크 계층 프레임(link-layer frame)`을 만든다.

<br/>

---

<br/>

_캡슐화 과정은 위에서 말한 것보다 더 복잡할 수 있다._

큰 메시지는 여러 개의 트랜스포트 계층 세그먼트로 분할될 수 있으며, 그들 각각은 여러 개의 네트워크 계층 데이터그램으로 분할될 수 있다.

**그러고 나서 수신 측에서 각 세그먼트는 분할된 데이터그램들로 재구성되어야 한다.**