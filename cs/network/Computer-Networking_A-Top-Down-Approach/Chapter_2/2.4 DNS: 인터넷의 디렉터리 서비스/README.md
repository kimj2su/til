## 2.4 DNS: 인터넷의 디렉터리 서비스
인터넷 호스트를 식별할 수 있는 식별자 중 하나는 호스트 이름(host name)이다.  
호스트 이름은 가변길이의 알파뉴메릭 문자로 구성되므로 라우터가 처리하는데 어려움이 있다.  
이러한 이유로 호스트는 흔히 말하는 IP(IP address)로도 식별된다.  
IP 주소는 4바이트로 구성되고 계층구조를 갖는다. IP주소는 121.7.106.83과 같은 형태이고, 0~255의 십진수로 표현하는 각 바이트는 점으로 구분된다.

## 2.4.1 DNS가 제공하는 서비스
호스트 이름과 IP주소로 호스트를 식별하는 두가지 방법이 있었다.  
사람은 좀 더 기억하기 쉬운 호스트 이름 식별자를 좋아하고, 라우터는 고정 길이의 계층구조를 가진 IP주소를 좋아한다.  
이러한 선호 차이를 절충하기 위해, 호스트 이름을 IP 주소로 변환해주는 디렉터리 서비스가 DNS이다.

### DNS(Domain Name System)
DNS는 호스트 이름을 IP 주소로 변환하거나, 반대로 IP 주소를 호스트 이름으로 변환하는 분산 데이터베이스 시스템이다.  
DNS 서버는 주로 BIND(Berkeley Internet Name Domain)라는 소프트웨어로 구현되어 있는 유닉스 컴퓨터이다.  
DNS는 UDP 상에서 수행되고 포트번호 53을 이용한다.

### DNS의 수행 과정
1. 사용자 컴퓨터는 DNS 애플리케이션의 클라이언트 측을 수행한다.
2. 브라우저는 URL로부터 호스트 이름 www.google.com을 추출하고 그 호스트 이름을 DNS 애플리케이션의 클라이언트 측에 넘긴다.
3. DNS 클라이언트는 DNS 서버로 호스트 이름을 포함하는 질의를 보낸다.
4. DNS 클라이언트는 결국 호스트 이름에 대한 IP 주소를 가진 응답을 받게 된다.
5. 브라우저가 DNS로부터 IP 주소를 받으면, 브라우저는 해당 IP주소와 그 주소의 80번 포트에 위치하는 HTTP 서버 프로세스로 TCP 연결을 초기화한다.

DNS는 사용하는 인터넷 애플리케이션에 추가지연을 가져온다.  
다행스럽게도 IP 주소는 가까운 DNS 서버에 캐싱되어 있어서 평군 DNS 뿐만 아니라 DNS 네트워크 트래픽 감소에 도움을 준다.

#### 호스트 에일리어싱
DNS는 호스트 이름을 IP 주소로 변환하는 것 뿐만 아니라, 여러개의 호스트 이름을 하나의 IP 주소로 변환하는 것도 지원한다.

#### 메일 서버 에일리어싱
메일 서버 에일리어싱은 메일 서버의 호스트 이름을 메일 서버의 IP 주소로 변환하는 것이다.

#### 부하 분산(load distribution)
DNS는 부하 분산을 위해 사용될 수 있다.
중복 웹 서버의 경우 여러 IP 주소가 하나의 정식 호스트 이름과 연관되어 있다.


## 2.4.2 DNS 동작 원리 개요

![스크린샷 2023-11-08 오후 2 21 42](https://github.com/jisu3316/til/assets/95600042/a9c23eee-a13d-4ddf-8f49-571aa3247cdb)

### 분산 계층 데이터베이스
DNS는 많은 서버를 이용하고 이들을 계층 형태로 구성하며 전 세계에 분산시킨다.  
어떠한 단일 DNS 서버도 인터넷에 있는 모든 호스트에 대한 매핑을 갖지 않는 대신 그것은 DNS 서버 사이에 분산된다.  

### 루트 DNS 서버
루트 서버들은 13개의 다른 루트 서버 복사체이고, 12개의 다른 기관에서 관리되며, 인터넷 할당 번호 관리기관[IANA(Internet Assigned Numbers Authority)](https://www.iana.org/)에서 관리된다.  
루트 네임 서버들과 이를 관리하는 기관과 그들의 IP 주소 목록은 [Root Servers 2020]에서 볼 수 있다.  
루트 네임 서버는 TLD 서버의 IP주소들을 제공한다.

### 최상위 레벨 도메인(TLD) 서버 
TLD 서버는 .com, .edu, .org, .net, .kr 등의 최상위 도메인을 관리한다.  
베리사인 글로벌 레지스트리 서비스사는 com에 대한 TLD 서버를 담당.  
에듀코즈가는 edu TLD에 대해 담당.  
TLD 서버는 책임 DNS 서버에 대한 IP 주소를 제공한다.

### 책임 DNS 서버
인터넷에서 접근하기 쉬운 호스트를 가진 모든 기관은 호스트 이름을 IP 주소로 매핑하는 공개적인 DNS 레코드를 제공해야 한다.  
기관의 책임 DNS 서버는 이 DNS 레코드를 갖고 있다.  
또한 기관은 이 레코드를 갖도록 자신의 책임 DNS 서버의 구현을 선택할 수 있고, 일부 서비스 제공자의 책임 DNS 서버에 이 레코드를 저장하도록 비용을 지불한다.  

ISP들은 로컬 DNS 서버를 갖는다.

### DNS 캐싱
DNS는 지연 성능 향상과 네트워크의 DNS 메시지 수를 줄이기 위해 캐싱을 사용한다.  
질의 사슬에서 DNS 서버가 DNS 응답을 받았을때(호스트 이름을 IP로 매핑하기) 그것은 로컬 메모리에 응답에 대한 정보를 저장할 수 있다.  


## 2.4.3 DNS 레코드와 메시지
DNS 분산 데이터베이스를 구현한 DNS 서버들은 호스트 이름을 IP 주소로 매핑하기위한 자원 레코드(resource record, PR)를 저장한다.  
각 DNS는 하나 이상의 자원 레코드를 가진 메시지로 응답한다.   

### DNS 레코드
Name, Value, type, TTL 4개의 튜플로 되어 있다.  
TTL은 자원 레코드의 생존기간(time to live)이다.(자원이 캐시에서 제거되는 시간을 결정).  

• Type=A이면, Name은 호스트 이름이고 Value는 호스트 이름에 대한 IP 주소다.
    따라서 Type A 레코드는 표준 호스트 이름의 IP 주소 매핑을 제공한다. 
    예를 들어,(relayl.bar. foo. com, 145.37.93.126, А) 는 Туре А 레코^다.

• Type=NS이면, Name은 도메인(예: foo. com)이고 Value는 도메인 내부의 호스트에 대한 IP 주소를 얻을 수 있는 방법을 아는 책임 DNS 서버의 호스트 이름이 다.  예를들어, (foo.com, dns. foo.com, NS)는Type NS 레코드다.

• Type=CNAME이면, Value는 별칭 호스트 이름 Name에 대한 정식 호스트 이름이다. 이 레코드는 질의 호스트에게 호스트 이름에 대한 정식 이름을 제공한다. 예를 들 어, (foo.com, relayl.bar. foo.com, CNAME)은CNAME 레코_£다.

• Type=MX°]4i, Value는 별칭 호스트 이름 Name을 갖는 메일 서버의 정식 이름이다. 예를들어, ( , mail .bar. foo. com, MX) 는 MX 레코드다.
MX 레코드는 메일 서버의 호스트 이름이 간단한 별칭을 갖는 것을 허용한다.  
어떤 회사는 한 메일 서버와 다른 서버들(웹 서버 같은 것)이 같은 별칭을 가질 수 있다.  
메일 서버의 정식 이름을 얻기 위해 DNS 클라이언트는 MX 레코드에 대한 질의를 한다.  
다른 서버의 정식 이름을 얻기 위해 DNS 클라이언트는 CNAME 레코드에 대한 질의를 한다.


### DNS 메시지

![스크린샷 2023-11-08 오후 4 30 43](https://github.com/jisu3316/til/assets/95600042/31af764e-a6bc-45b0-babb-1f435ca3405c)

DNS의 요청과, 응답은 위와 같은 포맷을 가지고 있다.  

#### 헤더 영역
- 헤더는 처음 1바이트로 구성되고, 여러개 필드로 구성되어 있다.
- 첫 필드는 질의를 식별하는 16비트 숫자다. 이 식별자는 질의에 대한 응답 메시지에 복사되어, 클라이언트가 보낸 질의와 수신된 응답 간의 일치를 식별하게 한다.  
- 플레그 필드에는 1비트 QR 필드가 있다. 이 필드는 0이면 질의 메시지를 의미하고, 1이면 응답 메시지를 의미한다.
- 헤더에 4개의 ‘개수’ 필드가 있다. 이들 필드는 헤더 다음에 오는 데이터 영역의 네 가지 타입의 발생 횟수를 나타낸다.

#### 질문 영역
- 현재 질의에 대한 정보를 포함한다.
- 질의 되는 이름을 포함하는 이름 필드, 타입필드를 포함한다.

#### 답변 영역
- 서버로부터의 응답한느 영역이다. 
- 원래 질의된 이름에 대한 자원 레코드를 포함한다.
- 각 자원 레코드에 Type, Value, TTL이 있다.
- 응답으로 여러 개의 PR을 보낼 수 있다. -> 호스트 이름은 여러개의 IP 주소를 가질 수 있다.

#### 책임 영역
- 다른 책임 서버의 레코드를 포함한다.

#### 추가 영역
- 다른 도움이 되는 레코드를 포함하고 있다.
- MX 질의에 대한 응답에서 응답 필드는 전자 메일  서버의 정식 호스트 이름을 제공하는 자원 레코드를 갖고 있다.
- 추가 영역은 메일 서버의 정식 호스트 이름에 대한 IP주소를 제공하는 Type A 레코드를 포함한다


### DNS 데이터베이스에 레코드 삽입

도메인 네임 networkutopia.com을 등록 기관(DNS registrar)에 등록한다고 가정해보자.

> `등록 기관(DNS registrar)`은 도메인 네임의 유일성을 확인하고,  
> 그 도메인 네임을 DNS 데이터베이스에 넣고, 그 서비스에 대한 요금을 받는 상업 기관이다.

이전에는 작은 등록기관이 독점했었지만, 이제는 많은 기관이 경쟁하고 ICANN이 이러한 여러 등록기관을 승인해준다.  

<br/>

도메인 네임을 어떤 등록기관에 등록할 때 등록 기관에 주책임 서버와 부책임 서버의 이름과 IP 주소를 등록기관에 제공해야 한다.

- 주책임 서버 : `dns1.networkutopia.com` / 주책임 서버 IP : 212.2.212.1
- 부책임 서버 : `dns2.networkutopia.com` / 부책임 서버 IP : 212.2.212.2

위와 같다고 가정하자.

<br/>

이 두 책임 DNS 서버 각각에 대해 등록 기관은 `Type NS`와 `Type A` 레코드가 **TLD com 서버에 등록되도록 확인한다.**

특히 주책임 서버의 경우 다음 두 개의 자원 레코드를 DNS 서버에 삽입한다.

```
(networkutopia.com, dns1.networkutopia.com, NS)
(dns1.networkutopia.com, 212.212.212.1, A)
```

<br/>

또한, `Type A` 레코드와 메일 서버에 대한 `Type MX` 자원 레코드가 **책임 DNS 서버에 등록되는 것을 확인한다.**

이러한 모든 단계가 끝나면 여러 사람들이 웹 사이트를 방문할 수 있고, 전자메일을 보낼 수 있게 된다.

<br/>
<br/>

## DNS 취약점

### DDoS 대역폭 플러딩 공격

공격자는 DNS 루트 서버로 다량의 패킷을 보내려는 시도를 하여 다른 DNS 질의들이 응답을 받지 못하게 하려 한다.

실제로 이 일이 일어났지만, 많은 DNS 루트 서버들은 루트 서버로 향하는 공격자가 사용한 ICMP 핑 메시지를 블록하도록 형상화한 패킷 필터로 보호되었고,  
대부분의 로컬 DNS 서버가 최상위 도메인 서버들의 IP 주소들을 캐싱하고 있어서 피해가 거의 없었다.

<br/>

즉, 더 효과적인 공격은 최상위 도메인 서버를 공격하는 것이고, 실제로 최상위 도메인 서비스 제공자 Dyn에 이러한 일이 발생했다.

이는 유명 애플리케이션들이 무차별 교란되는 결과를 야기했다.

<br/>

### DNS 중독 공격

공격자는 DNS 서버로 가짜 응답을 보내어 그 서버가 자신의 캐시에 가짜 레코드를 받아들이도록 속임수를 쓴다.

이러한 공격은 웹 사용자들을 공격자의 웹사이트로 유도하는 데 이용될 수 있다.

이러한 공격을 막기 위해 DNS 보안 확장 프로토콜이 개발되어 사용되고 있다.